project2.lst - generated by MGTEK Assembler ASM11 V1.26 Build 144 for WIN32 (x86) - Fri Dec 05 15:40:18 2025

    1:                                 ; --- DEFINITIONS (Offsets from Base $1000) ---
    2:          =00001000              REGBAS  EQU     $1000       ; Register Base Address
    3:                                 
    4:          =00000000              PORTA   EQU     $00         ; Offset for Port A
    5:          =00000004              PORTB   EQU     $04         ; Offset for Port B
    6:          =00000003              PORTC   EQU     $03         ; Offset for Port C
    7:          =00000007              DDRC    EQU     $07         ; Offset for Data Direction C
    8:                                 
    9:          =0000002B              BAUD    EQU     $2B         ; SCI Baud Register
   10:          =0000002D              SCCR2   EQU     $2D         ; SCI Control Register 2
   11:          =0000002E              SCSR    EQU     $2E         ; SCI Status Register
   12:          =0000002F              SCDR    EQU     $2F         ; SCI Data Register
   13:                                 
   14:          =0000003C              HPRIO   EQU     $3C         ; Offset for HPRIO (Mode Select)
   15:                                 
   16:          =000000FF              STACK   EQU     $00FF       ; Top of Internal RAM
   17:                                 
   18:          =00000000                      ORG     $0000       ; Start of Program in RAM
   19:                                 
   20:     0000                        START:
   21:     0000 8E 00FF                        LDS     #STACK      ; 1. Initialize Stack
   22:                                 
   23:     0003 CE 1000                        LDX     #REGBAS     ; 2. Load X with $1000 (Exp 8 Style)
   24:                                 
   25:                                         ; --- MODE FIX ---
   26:                                         ; Force Single Chip Mode (MDA=0) but keep Boot ROM (RBOOT=1)
   27:     0006 86 C0                          LDAA    #$C0        
   28:     0008 A7 3C                          STAA    HPRIO,X     ; Write to $103C
   29:                                 
   30:                                         ; --- CONFIGURE PORT C ---
   31:     000A 86 00                          LDAA    #$00        ; Set Port C to INPUT
   32:     000C A7 07                          STAA    DDRC,X      ; Write to $1007
   33:                                 
   34:                                         ; --- INITIALIZE CONTROL PINS ---
   35:                                         ; CE (Bit 5) and OE (Bit 6) HIGH (Inactive)
   36:     000E A6 00                          LDAA    PORTA,X     
   37:     0010 8A 60                          ORAA    #%01100000  
   38:     0012 A7 00                          STAA    PORTA,X     
   39:                                 
   40:                                         ; --- CONFIGURE SCI (SERIAL) ---
   41:                                         ; Set to 9600 Baud (Assuming 8MHz Crystal / 2MHz E-Clock)
   42:     0014 86 30                          LDAA    #$30        ; SCP1:0=11 (Div 13), SCR2:0=000 (Div 1)
   43:     0016 A7 2B                          STAA    BAUD,X
   44:     0018 86 0C                          LDAA    #$0C        ; Enable Tx and Rx
   45:     001A A7 2D                          STAA    SCCR2,X
   46:                                 
   47:                                         ; ==================================================
   48:                                         ; !!! CRITICAL FIX: STARTUP DELAY !!!
   49:                                         ; We wait here for ~1 second to give the Python script 
   50:                                         ; time to switch the PC's baud rate to 9600.
   51:                                         ; ==================================================
   52:     001C 9D 48                          JSR     LONG_DELAY
   53:                                         ; ==================================================
   54:                                 
   55:                                         ; --- INIT COUNTERS ---
   56:     001E 4F                             CLRA                ; A = Address Counter (starts at 0)
   57:     001F C6 19                          LDAB    #25         ; B = Byte Counter (25 bytes)
   58:                                 
   59:     0021                        READ_LOOP:
   60:                                         ; 1. Send Address to EPROM (via Port B)
   61:     0021 A7 04                          STAA    PORTB,X     
   62:                                 
   63:     0023 01                             NOP                 ; Stability delay
   64:                                 
   65:                                         ; 2. Activate EPROM (CE/OE Low)
   66:     0024 36                             PSHA                ; Save Address
   67:     0025 A6 00                          LDAA    PORTA,X     
   68:     0027 84 9F                          ANDA    #%10011111  ; Clear Bits 5 & 6
   69:     0029 A7 00                          STAA    PORTA,X     
   70:     002B 32                             PULA                ; Restore Address
   71:                                 
   72:     002C 01                             NOP                 ; Access Time Delay
   73:     002D 01                             NOP
   74:                                 
   75:                                         ; 3. Read Data from EPROM
   76:     002E 36                             PSHA                ; Save Address (A) to Stack
   77:     002F A6 03                          LDAA    PORTC,X     ; A now holds the DATA from EPROM
   78:                                         
   79:                                         ; ==============================================
   80:                                         ; 4. SEND DATA TO PC
   81:                                         ; ==============================================
   82:     0031 9D 41                          JSR     SEND_SERIAL ; Go send 'A' to the computer
   83:                                         ; ==============================================
   84:                                 
   85:     0033 32                             PULA                ; Restore Address (A) from Stack
   86:                                 
   87:                                         ; 5. Deactivate EPROM (CE/OE High)
   88:     0034 36                             PSHA
   89:     0035 A6 00                          LDAA    PORTA,X
   90:     0037 8A 60                          ORAA    #%01100000  
   91:     0039 A7 00                          STAA    PORTA,X
   92:     003B 32                             PULA
   93:                                 
   94:                                         ; 6. Next Byte
   95:     003C 4C                             INCA                ; Increment Address
   96:     003D 5A                             DECB                ; Decrement Counter
   97:     003E 26 E1                          BNE     READ_LOOP   ; Loop
   98:                                 
   99:     0040 3F                             SWI                 ; Stop
  100:                                 
  101:                                 ; --- SUBROUTINE: Send Accumulator A to Serial Port ---
  102:     0041                        SEND_SERIAL:
  103:     0041 1F 2E 80 FC                    BRCLR   SCSR,X #$80 SEND_SERIAL ; Wait until TDRE (Transmit Empty) is 1
  104:     0045 A7 2F                          STAA    SCDR,X                  ; Send Data
  105:     0047 39                             RTS
  106:                                 
  107:                                 ; --- SUBROUTINE: Long Delay (~1 Second) ---
  108:     0048                        LONG_DELAY:
  109:     0048 183C                           PSHY                ; Save Y register
  110:     004A 3C                             PSHX                ; Save X register (CRITICAL: We need X for REGBAS later)
  111:                                         
  112:     004B 18CE 0010                      LDY     #$0010      ; Outer Loop Counter
  113:     004F                        DELAY_OUTER:
  114:     004F CE FFFF                        LDX     #$FFFF      ; Inner Loop Counter (Max 65535)
  115:     0052                        DELAY_INNER:
  116:     0052 09                             DEX
  117:     0053 26 FD                          BNE     DELAY_INNER ; Loop until X is 0
  118:     0055 1809                           DEY
  119:     0057 26 F6                          BNE     DELAY_OUTER ; Loop until Y is 0
  120:                                         
  121:     0059 38                             PULX                ; Restore X (Base Address $1000)
  122:     005A 1838                           PULY                ; Restore Y
  123:     005C 39                             RTS
