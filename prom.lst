prom.lst - generated by MGTEK Assembler ASM11 V1.26 Build 144 for WIN32 (x86) - Fri Dec 05 15:56:03 2025

    1:                                 ; ======================================================================
    2:                                 ; HC11 EPROM PROGRAMMER (Part 2) - FIXED BRANCH RANGE
    3:                                 ; Target: 2764 (NMOS) | Algo: 1ms Pulse + Verify + Overprogram
    4:                                 ; ======================================================================
    5:                                 
    6:          =00001000              REGBAS  EQU     $1000
    7:          =00000000              PORTA   EQU     $00
    8:          =00000004              PORTB   EQU     $04
    9:          =00000003              PORTC   EQU     $03
   10:          =00000007              DDRC    EQU     $07
   11:          =0000002E              SCSR    EQU     $2E
   12:          =0000002F              SCDR    EQU     $2F
   13:          =0000003C              HPRIO   EQU     $3C
   14:          =000000FF              STACK   EQU     $00FF
   15:                                 
   16:                                 ; Constants
   17:          =00000019              MAX_RETRIES EQU 25
   18:          =00000020              VPROG_BIT   EQU %00100000   ; PA5? Wait, PA3 is PSU. 
   19:                                 ; CORRECTION: Based on your previous code structure:
   20:                                 ; PA3 = PSU (High Voltage Control)
   21:                                 ; PA4 = PGM
   22:                                 ; PA5 = OE
   23:                                 ; PA6 = CE
   24:                                 
   25:          =00000000                      ORG     $0000           ; Must start at 0000 for Bootloader
   26:                                 
   27:     0000                        START:
   28:     0000 8E 00FF                        LDS     #STACK
   29:     0003 CE 1000                        LDX     #REGBAS         ; X points to Registers ($1000)
   30:                                 
   31:                                         ; 1. Force Single Chip Mode
   32:     0006 86 C0                          LDAA    #$C0
   33:     0008 A7 3C                          STAA    HPRIO,X
   34:                                 
   35:                                         ; 2. Config Port A
   36:                                         ; Default: PSU Off(0), Others Inactive(1) -> 0111 0000 ($70)
   37:     000A 86 70                          LDAA    #$70
   38:     000C A7 00                          STAA    PORTA,X
   39:                                 
   40:                                         ; 3. Config Serial (9600 Baud)
   41:     000E 86 30                          LDAA    #$30
   42:     0010 A7 2B                          STAA    $2B,X           ; BAUD
   43:     0012 86 0C                          LDAA    #$0C
   44:     0014 A7 2D                          STAA    $2D,X           ; SCCR2
   45:                                 
   46:                                         ; 4. Wait for PC to switch baud rate
   47:     0016 9D E8                          JSR     DELAY_1S
   48:                                 
   49:     0018                        MAIN_LOOP:
   50:     0018 9D DA                          JSR     RX_BYTE         ; Wait for command
   51:     001A 81 42                          CMPA    #'B'
   52:     001C 27 0A                          BEQ     DO_BLANK
   53:     001E 81 50                          CMPA    #'P'
   54:     0020 27 21                          BEQ     DO_PROGRAM
   55:     0022 81 52                          CMPA    #'R'
   56:     0024 27 0E                          BEQ     DO_READ
   57:     0026 20 F0                          BRA     MAIN_LOOP
   58:                                 
   59:                                 ; --- BLANK CHECK ---
   60:     0028                        DO_BLANK:
   61:     0028 9D D6                          JSR     PSU_READ        ; Vcc=5V
   62:     002A 5F                             CLRB                    ; B = Addr Count (0-24)
   63:     002B                        BL_LOOP:
   64:     002B 9D B9                          JSR     READ_BYTE_SUB   ; Read byte at Addr B into A
   65:     002D 81 FF                          CMPA    #$FF
   66:                                         ;BNE     SEND_FAIL
   67:     002F 5C                             INCB
   68:     0030 C1 19                          CMPB    #25
   69:     0032 26 F7                          BNE     BL_LOOP
   70:                                         ;BRA     SEND_OK
   71:                                 
   72:                                 ; --- READ ROUTINE ---
   73:     0034                        DO_READ:
   74:     0034 9D D6                          JSR     PSU_READ
   75:     0036 5F                             CLRB
   76:     0037                        RD_LOOP:
   77:     0037 9D B9                          JSR     READ_BYTE_SUB
   78:     0039 9D E1                          JSR     TX_BYTE         ; Send Data
   79:     003B 5C                             INCB
   80:     003C C1 19                          CMPB    #25
   81:     003E 26 F7                          BNE     RD_LOOP
   82:     0040 7E 0018                        JMP     MAIN_LOOP       ; Long jump back to main
   83:                                 
   84:                                 ; --- PROGRAM ROUTINE ---
   85:     0043                        DO_PROGRAM:
   86:                                         ; 1. Enable High Voltage (Vpp=13V, Vcc=6V)
   87:     0043 9D D2                          JSR     PSU_PROG
   88:     0045 9D F0                          JSR     DELAY_50MS      ; Wait for rise
   89:                                 
   90:     0047 5F                             CLRB                    ; B = Addr Count
   91:     0048                        PROG_L:
   92:     0048 9D DA                          JSR     RX_BYTE         ; Receive Data Byte from PC
   93:     004A 37                             PSHB                    ; Save Addr
   94:                                         
   95:                                         ; Programming Algorithm
   96:     004B E7 04                          STAB    PORTB,X         ; Set Address
   97:     004D A7 03                          STAA    PORTC,X         ; Set Data
   98:                                         
   99:     004F 36                             PSHA                    ; Save Data
  100:     0050 86 FF                          LDAA    #$FF
  101:     0052 A7 07                          STAA    DDRC,X          ; Port C Output
  102:                                         
  103:                                         ; CE Low (Enable Chip)
  104:     0054 1D 00 40                       BCLR    PORTA,X $40     
  105:                                         
  106:     0057 7F 0050                        CLR     $50             ; Pulse Counter N = 0 (using address $0050)
  107:                                         
  108:     005A                        PULSE_L:
  109:                                         ; 1ms Program Pulse (PGM Low)
  110:     005A 1D 00 10                       BCLR    PORTA,X $10     ; PA4 Low
  111:     005D 9D FF                          JSR     DELAY_1MS
  112:     005F 1C 00 10                       BSET    PORTA,X $10     ; PA4 High
  113:                                         
  114:     0062 7C 0050                        INC     $50             ; N++
  115:                                         
  116:                                         ; Verify Step
  117:     0065 6F 07                          CLR     DDRC,X          ; Float Bus
  118:     0067 1D 00 20                       BCLR    PORTA,X $20     ; OE Low (PA5)
  119:     006A 01                             NOP                     ; Access delay
  120:     006B A6 03                          LDAA    PORTC,X         ; Read
  121:     006D 1C 00 20                       BSET    PORTA,X $20     ; OE High
  122:                                         
  123:     0070 33                             PULB                    ; Restore Target Data (into B temporarily)
  124:     0071 37                             PSHB                    ; Push back for next iter
  125:     0072 11                             CBA                     ; Compare Read(A) vs Target(B)
  126:     0073 27 16                          BEQ     OVER_PROG       ; Match? Go to Overprogram
  127:                                         
  128:                                         ; Restore Bus for next pulse
  129:     0075 86 FF                          LDAA    #$FF
  130:     0077 A7 07                          STAA    DDRC,X
  131:     0079 E7 03                          STAB    PORTC,X         ; Put data back
  132:                                         
  133:     007B 96 50                          LDAA    $50
  134:     007D 81 19                          CMPA    #25             ; MAX_RETRIES
  135:                                         
  136:                                         ; FIX 1: LONG BRANCH LOGIC
  137:     007F 27 03                          BEQ     PROG_FAIL_JMP   ; If Equal to 25, Fail.
  138:     0081 7E 005A                        JMP     PULSE_L         ; Else, Long Jump back
  139:                                         
  140:     0084                        PROG_FAIL_JMP:
  141:                                         ; Fail
  142:     0084 32                             PULA                    ; Clean stack
  143:     0085 33                             PULB                    ; Clean Addr
  144:     0086 9D D6                          JSR     PSU_READ        ; Safety Shutdown
  145:     0088 7E 00CB                        JMP     SEND_FAIL       ; Long jump
  146:                                 
  147:     008B                        OVER_PROG:
  148:                                         ; Overprogram Pulse = 3ms * N
  149:     008B 32                             PULA                    ; Clean Stack (Target Data)
  150:                                         
  151:     008C 86 FF                          LDAA    #$FF
  152:     008E A7 07                          STAA    DDRC,X          ; Drive Data again
  153:     0090 33                             PULB                    ; Get Target Data
  154:     0091 E7 03                          STAB    PORTC,X         ; Assert Data
  155:                                         
  156:                                         ; PGM Low
  157:     0093 1D 00 10                       BCLR    PORTA,X $10
  158:                                         
  159:     0096 96 50                          LDAA    $50             ; Get N
  160:     0098                        OV_L:   
  161:     0098 9D FF                          JSR     DELAY_1MS
  162:     009A 9D FF                          JSR     DELAY_1MS
  163:     009C 9D FF                          JSR     DELAY_1MS
  164:     009E 4A                             DECA
  165:                                         
  166:                                         ; FIX 2: LONG BRANCH LOGIC
  167:     009F 27 03                          BEQ     OV_DONE         ; If A=0, done
  168:     00A1 7E 0098                        JMP     OV_L            ; Else, Long jump back
  169:     00A4                        OV_DONE:
  170:                                         
  171:                                         ; PGM High
  172:     00A4 1C 00 10                       BSET    PORTA,X $10
  173:                                         
  174:                                         ; CE High (Disable)
  175:     00A7 1C 00 40                       BSET    PORTA,X $40
  176:     00AA 6F 07                          CLR     DDRC,X          ; Float Bus
  177:                                         
  178:     00AC 5C                             INCB                    ; Next Address (B was restored by PULB)
  179:     00AD C1 19                          CMPB    #25
  180:     00AF 27 03                          BEQ     PROG_DONE       ; If 25, done
  181:     00B1 7E 0048                        JMP     PROG_L          ; Else, next byte
  182:                                         
  183:     00B4                        PROG_DONE:
  184:     00B4 9D D6                          JSR     PSU_READ
  185:     00B6 7E 00C7                        JMP     SEND_OK
  186:                                 
  187:                                 ; --- SUBROUTINES ---
  188:                                 
  189:     00B9                        READ_BYTE_SUB:
  190:     00B9 E7 04                          STAB    PORTB,X         ; Address
  191:     00BB 6F 07                          CLR     DDRC,X          ; Input
  192:     00BD 1D 00 60                       BCLR    PORTA,X $60     ; CE/OE Low
  193:     00C0 01                             NOP
  194:     00C1 A6 03                          LDAA    PORTC,X         ; Read
  195:     00C3 1C 00 60                       BSET    PORTA,X $60     ; CE/OE High
  196:     00C6 39                             RTS
  197:                                 
  198:     00C7                        SEND_OK:
  199:     00C7 86 4B                          LDAA    #'K'
  200:     00C9 20 02                          BRA     TX_JMP
  201:     00CB                        SEND_FAIL:
  202:     00CB 86 46                          LDAA    #'F'
  203:     00CD 9D E1                  TX_JMP: JSR     TX_BYTE
  204:     00CF 7E 0018                        JMP     MAIN_LOOP
  205:                                 
  206:     00D2                        PSU_PROG:
  207:     00D2 1C 00 08                       BSET    PORTA,X $08     ; PA3 High
  208:     00D5 39                             RTS
  209:     00D6                        PSU_READ:
  210:     00D6 1D 00 08                       BCLR    PORTA,X $08     ; PA3 Low
  211:     00D9 39                             RTS
  212:                                 
  213:     00DA                        RX_BYTE:
  214:     00DA 1F 2E 20 FC                    BRCLR   SCSR,X $20 RX_BYTE
  215:     00DE A6 2F                          LDAA    SCDR,X
  216:     00E0 39                             RTS
  217:     00E1                        TX_BYTE:
  218:     00E1 1F 2E 80 FC                    BRCLR   SCSR,X $80 TX_BYTE
  219:     00E5 A7 2F                          STAA    SCDR,X
  220:     00E7 39                             RTS
  221:                                 
  222:     00E8                        DELAY_1S:
  223:     00E8 183C                           PSHY
  224:     00EA 18CE 03E8                      LDY     #1000
  225:     00EE 20 06                          BRA     DL_LOOP
  226:     00F0                        DELAY_50MS:
  227:     00F0 183C                           PSHY
  228:     00F2 18CE 0032                      LDY     #50
  229:     00F6                        DL_LOOP:
  230:     00F6 9D FF                          JSR     DELAY_1MS
  231:     00F8 1809                           DEY
  232:     00FA 26 FA                          BNE     DL_LOOP
  233:     00FC 1838                           PULY
  234:     00FE 39                             RTS
  235:                                 
  236:     00FF                        DELAY_1MS:
  237:     00FF 3C                             PSHX
  238:     0100 CE 010A                        LDX     #266
  239:     0103 09                     D1:     DEX
  240:     0104 26 FD                          BNE     D1
  241:     0106 38                             PULX
  242:     0107 39                             RTS
